# Unit Tests Configuration
# Using assert-based testing (no external dependencies required)

enable_testing()

# RWKV Unit Test
add_executable(test_rwkv unit/test_rwkv.cpp)
target_link_libraries(test_rwkv PRIVATE ryzen_llm_rwkv)
target_include_directories(test_rwkv PRIVATE ${CMAKE_SOURCE_DIR}/src/core/rwkv)
add_test(NAME RWKV COMMAND test_rwkv)

# KV Cache Unit Test  
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_kv_cache.cpp)
    add_executable(test_kv_cache unit/test_kv_cache.cpp)
    target_link_libraries(test_kv_cache PRIVATE ryzen_llm_optimization)
    target_include_directories(test_kv_cache PRIVATE ${CMAKE_SOURCE_DIR}/src/optimization/memory)
    add_test(NAME KVCache COMMAND test_kv_cache)
endif()

# Mamba Unit Test
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_mamba.cpp)
    add_executable(test_mamba unit/test_mamba.cpp)
    target_link_libraries(test_mamba PRIVATE mamba_ssm)
    target_include_directories(test_mamba PRIVATE ${CMAKE_SOURCE_DIR}/src/core/mamba)
    add_test(NAME Mamba COMMAND test_mamba)
endif()

# AVX512 MATMUL Unit Test
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_avx512_matmul.cpp)
    add_executable(test_avx512_matmul unit/test_avx512_matmul.cpp)
    target_link_libraries(test_avx512_matmul PRIVATE ryzen_llm_optimization)
    target_include_directories(test_avx512_matmul PRIVATE ${CMAKE_SOURCE_DIR}/src/optimization/avx512)
    add_test(NAME AVX512MATMUL COMMAND test_avx512_matmul)
endif()

# BitNet Unit Test (Note: this is a Python test, skip for C++ build)
# See: unit/test_bitnet_matmul.py

# T-MAC Unit Test
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_tmac.cpp)
    add_executable(test_tmac unit/test_tmac.cpp)
    target_link_libraries(test_tmac PRIVATE ryzen_llm_tmac)
    target_include_directories(test_tmac PRIVATE ${CMAKE_SOURCE_DIR}/src/core/tmac)
    add_test(NAME TMAC COMMAND test_tmac)
endif()

# Print test summary
message(STATUS "")
message(STATUS "========== Tests Configuration ==========")
message(STATUS "Tests enabled (assert-based)")
message(STATUS "Available tests:")
message(STATUS "  - test_rwkv (RWKV Time Mixing)")
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_kv_cache.cpp)
    message(STATUS "  - test_kv_cache (KV Cache Memory)")
endif()
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_mamba.cpp)
    message(STATUS "  - test_mamba (Mamba SSM)")
endif()
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_avx512_matmul.cpp)
    message(STATUS "  - test_avx512_matmul (AVX-512 MATMUL)")
endif()
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/unit/test_tmac.cpp)
    message(STATUS "  - test_tmac (T-MAC GEMM)")
endif()
message(STATUS "")
message(STATUS "Run tests with: ctest -V")
message(STATUS "=========================================")
message(STATUS "")
